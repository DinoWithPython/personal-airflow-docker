üöÄ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ Apache Airflow —Å PostgreSQL (Docker)

üìå –û–ø–∏—Å–∞–Ω–∏–µ

–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Apache Airflow —Å PostgreSQL —á–µ—Ä–µ–∑ Docker –∏ Docker Compose. –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:
- —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è DAG'–æ–≤,
- –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–µ–Ω—Å–æ—Ä–æ–≤ –∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤,
- —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ –∏ –ø–ª–∞–≥–∏–Ω–∞–º–∏ –∏  –ø—Ä–æ—á–µ–º—É.
___
‚úÖ –§—É–Ω–∫—Ü–∏–∏

‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –≤—Å—ë –≥–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É –≤ 3 –∫–æ–º–∞–Ω–¥—ã.<br>
üê≥ Docker + Docker Compose: –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å Airflow –ª–æ–∫–∞–ª—å–Ω–æ.<br>
üß™ PostgreSQL: –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö.<br>
üõ† –ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞: –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ docker-compose.yml.
____
üöÄ –ó–∞–ø—É—Å–∫

–ï—Å–ª–∏ –∑–∞–ø—É—Å–∫ –Ω–∞ –º–∞—à–∏–Ω–µ —Å WIndows, —Ç–æ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Docker.

1. –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:

```
git clone https://github.com/DinoWithPython/personal-airflow-docker.git
cd personal-airflow-docker
```
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:
```
docker-compose up -d  # –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—Å—Ç—è—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ, –ª–æ–≥–∏ –Ω–µ –≤–∏–¥–Ω—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
–∏–ª–∏

docker-compose up

# –°–ª–µ–¥—É—é—â–∞—è –∫–æ–º–∞–Ω–¥–∞ –Ω—É–∂–Ω–∞ –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Dockerfile –∏–ª–∏ requirements.txt
docker-compose up --build
```
<b>airflow-webserver:</b> –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Airflow (http://localhost:8080).<br>
<b>airflow-scheduler:</b> –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á.<br>
<b>postgres:</b> –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL.

3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

Airflow –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:<br>
http://localhost:8080<br>
–õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:<br>
 admin/admin

PostgreSQL:
```
–•–æ—Å—Ç: localhost
–ü–æ—Ä—Ç: 5432
–ë–∞–∑–∞: airflow
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: airflow
–ü–∞—Ä–æ–ª—å: airflow
```
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ—Å—Ç–≥—Ä–µ—Å –Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏–ª–∏—Å—å, –ø–æ—Å–∫–æ–ª—å–∫—É –ø—Ä–æ–µ–∫—Ç –±–æ–ª—å—à–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è airflow –∏  –≤–∑–∞–∏–º–æ–¥–µ–π—Ç—Å–≤–∏—è —Å –±–∞–∑–æ–π –Ω–µ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç—Å—è.
____
```
üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ docker-compose.yml        # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ Dockerfile                # –ö–∞—Å—Ç–æ–º–Ω—ã–π –æ–±—Ä–∞–∑ Airflow (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è)
‚îú‚îÄ‚îÄ requirements.txt          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
‚îú‚îÄ‚îÄ logs                      # –ü–∞–ø–∫–∞, –≤ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –ª–æ–≥–∏ airflow
‚îú‚îÄ‚îÄ plugins                   # –ü–∞–ø–∫–∞ –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
‚îî‚îÄ‚îÄ dags/                     # –ü—Ä–∏–º–µ—Ä—ã DAG'–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    ‚îî‚îÄ‚îÄ example_dag.py
```
___
üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

<b>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</b>
```
Airflow:
–í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ airflow-webserver, –≤ —Ä–∞–∑–¥–µ–ª–µ command —Å–æ–∑–¥–∞—ë—Ç—Å—è admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ docker-compose.yml.
–ü–æ—Ä—Ç: –∏–∑–º–µ–Ω–∏—Ç–µ ports –≤ —Ä–∞–∑–¥–µ–ª–µ airflow.
```
```
PostgreSQL:
–•–æ—Å—Ç/–ø–æ—Ä—Ç/–±–∞–∑–∞: –∏–∑–º–µ–Ω–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ postgres POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB –≤ docker-compose.yml.
```
<b>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö DAG'–æ–≤</b>

–°–æ–∑–¥–∞–π—Ç–µ .py —Ñ–∞–π–ª –≤ –ø–∞–ø–∫–µ dags/.

<i>–ü—Ä–∏–º–µ—Ä:</i>
```
python
from airflow import DAG
from airflow.operators.dummy_operator import DummyOperator
from datetime import datetime

dag = DAG('test_dag', description='–¢–µ—Å—Ç–æ–≤—ã–π DAG', start_date=datetime(2023, 1, 1))

task1 = DummyOperator(task_id='task1', dag=dag)
task2 = DummyOperator(task_id='task2', dag=dag)

task1 >> task2
```
–¢–∞–∫ –∂–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —É–∂–µ –ª–µ–∂–∏—Ç —Ç—Ä–∏ —Ñ–∞–π–ª–∞ –¥–ª—è —Ç–µ—Å—Ç–∞ –º–æ–¥—É–ª—è pendulum –∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ utc.
___
üö´ –û—Å—Ç–∞–Ω–æ–≤–∫–∞
```
docker compose down
–∏–ª–∏
docker-compose down -v
```
-v —É–¥–∞–ª–∏—Ç —Ç–∞–∫–∂–µ —Ç–æ–º–∞ –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë).
___
üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏<br>
[–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Airflow](https://airflow.apache.org/docs/)<br>
[Docker Compose Reference](https://docs.docker.com/reference/cli/docker/compose/)<br>
___
üìå –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `airflow-webserver` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `admin/admin`.

Healthcheck –¥–ª—è PostgreSQL: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä `postgres` –æ–∂–∏–¥–∞–µ—Ç, –ø–æ–∫–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π, –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º Airflow.
–ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–ø–æ–∫: DAG'–∏ –∏ –ª–æ–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (`./dags` –∏ `./logs`).

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: –í—Å–µ –ø–∞–∫–µ—Ç—ã –∏–∑ `requirements.txt` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –æ–±—Ä–∞–∑–∞ Airflow.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ—Ä—Å–∏—è `Airflow 2.5.0`, –Ω–∞ `PostgreSql 13` –∏ `python 3.9.*`.

–í –¥–æ–∫–µ—Ä-—Ñ–∞–π–ª–µ —Ç–∞–∫ –∂–µ —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `pip`. 

–ï—Å–ª–∏ —Ä–µ—à–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É `./logs`, —Ç–æ —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è–º.